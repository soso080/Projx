{% extends "base.html" %}

{% block title %}Projets - Projx{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-8">
    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert-{{ category }} p-4 mb-6 rounded-lg">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-green-600">Vos Projets</h1>
        <button onclick="toggleModal()"
                class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Nouveau Projet
        </button>
    </div>

    <!-- Modal de création -->
    <div id="createProjectModal"
         class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Nouveau Projet</h3>
                <button onclick="toggleModal()" class="text-gray-500 hover:text-gray-700">
                    ✕
                </button>
            </div>

            <form action="{{ url_for('create_project') }}" method="POST">
                <div class="space-y-4">
                    <div>
                        <label for="project_name" class="block text-sm font-medium text-gray-700">Nom du projet</label>
                        <input type="text" id="project_name" name="name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                    </div>

                    <div>
                        <label for="project_description"
                               class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="project_description" name="description" rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border"></textarea>
                    </div>

                    <div>
                        <label for="project_team" class="block text-sm font-medium text-gray-700">Équipe
                            assignée</label>
                        <select id="project_team" name="team_id" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                            <option value="">Sélectionnez une équipe</option>
                            {% for team in teams %}
                            <option value="{{ team._id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="toggleModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Annuler
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Créer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des projets -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for project in projects %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition-shadow">
            <div class="p-5">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">{{ project.name }}</h3>
                    <span class="px-2 py-1 text-xs rounded-full
                              {% if project.status == 'Terminé' %}bg-green-100 text-green-800
                              {% elif project.status == 'En retard' %}bg-red-100 text-red-800
                              {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ project.status }}
                    </span>
                </div>

                <p class="text-gray-600 mb-4">{{ project.description }}</p>

                <div class="border-t border-gray-200 pt-3">
                    <div class="flex items-center justify-between text-sm">
                        <div>
                            <p class="text-gray-500">Équipe:</p>
                            <p class="font-medium">
                                {{ project.team_details.name if project.team_details else "Non assigné" }}
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-500">Tâches:</p>
                            <p class="font-medium">{{ project.tasks|length }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-5 py-3 flex justify-between">
                <a href="{{ url_for('task', project_id=project._id) }}"
                   class="text-green-600 hover:text-green-800 font-medium text-sm">
                    Voir les tâches →
                </a>
                {% if project.created_by|string == session['user_id'] %}
                <div class="space-x-3">
                    <button class="text-blue-600 hover:text-blue-800 text-sm">Modifier</button>
                    <button class="text-red-600 hover:text-red-800 text-sm">Supprimer</button>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="col-span-full text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                      d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Aucun projet créé</h3>
            <p class="mt-1 text-sm text-gray-500">Commencez par créer votre premier projet.</p>
        </div>
        {% endfor %}
    </div>
</main>

<script>
    function toggleModal() {
        const modal = document.getElementById('createProjectModal');
        modal.classList.toggle('hidden');
    }

    // Fermer le modal si on clique en dehors
    window.onclick = function(event) {
        const modal = document.getElementById('createProjectModal');
        if (event.target === modal) {
            modal.classList.add('hidden');
        }
    }
</script>
{% endblock %}